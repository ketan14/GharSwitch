rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    // Is the user authenticated?
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get user's tenantId from custom claims
    function getTenantId() {
      return request.auth.token.tenantId;
    }

    // Is the user a super_admin?
    function isSuperAdmin() {
      return request.auth.token.role == 'super_admin';
    }

    // Get user's role for a specific tenant
    function getRole(tenantId) {
      return get(/databases/$(database)/documents/tenants/$(tenantId)/members/$(request.auth.uid)).data.role;
    }

    // ========================================
    // GLOBAL DEVICE REGISTRY
    // ========================================
    
    match /global_devices/{deviceId} {
      // Anyone authenticated can read (to check genuineness during registration)
      allow read: if isAuthenticated();
      // NO ONE can write via the Client SDK (SuperAdmin/Manufacturing only)
      allow write: if false;
    }

    // ========================================
    // TENANT SCOPED DATA
    // ========================================
    
    match /tenants/{tenantId} {
      // Allow read if the user's custom claim matches the tenantId
      allow read: if isAuthenticated() && getTenantId() == tenantId;
      // Allow update only for ADMINs
      // Allow update only for tenant_admin or super_admin
      allow update: if isAuthenticated() && getTenantId() == tenantId 
                    && getRole(tenantId) in ['tenant_admin', 'super_admin'];
      // Creation/deletion must go through Cloud Functions
      allow create, delete: if false;
      
      // ========================================
      // MEMBERS SUB-COLLECTION (RBAC)
      // ========================================
      
      match /members/{uid} {
        allow read: if isAuthenticated() && getTenantId() == tenantId;
        // Membership changes MUST go through Cloud Functions (to prevent role escalation)
        allow write: if false; 
      }
 
      // ========================================
      // DEVICES SUB-COLLECTION
      // ========================================
      
      match /devices/{deviceId} {
        allow read: if isAuthenticated() && getTenantId() == tenantId;
        // tenant_admin, admin, and user can update device config
        allow update: if isAuthenticated() && getTenantId() == tenantId 
                      && getRole(tenantId) in ['tenant_admin', 'admin', 'user', 'super_admin'];
        // Device registration/deletion MUST go through Cloud Functions
        allow create, delete: if false;
      }
    }

    // ========================================
    // USER PROFILES
    // ========================================
    
    match /users/{uid} {
      // Users can only read/write their own profile
      allow read, write: if isAuthenticated() && request.auth.uid == uid;
      // Super Admin can read all users (ReadOnly)
      allow read: if isAuthenticated() && isSuperAdmin();
    }

    // ========================================
    // ADMIN MONITORING VIEWS
    // ========================================
    
    match /adminViews/{viewId} {
        match /users/{userId} {
            // Only Super Admins can read monitoring summaries
            allow read: if isAuthenticated() && isSuperAdmin();
            // NO ONE can write via the Client SDK (Backend ONLY)
            allow write: if false;
        }
    }

    // ========================================
    // AUDIT LOGS
    // ========================================
    
    match /auditLogs/{logId} {
        // Super Admins can read logs for accountability
        allow read: if isAuthenticated() && isSuperAdmin();
        // Backend ONLY writes
        allow write: if false;
    }
  }
}
