{
    "rules": {
        "tenants": {
            "$tenantId": {
                // Allow reading tenant node if the user is a super_admin or belongs to this tenant
                ".read": "auth != null && (auth.token.role === 'super_admin' || auth.token.tenantId === $tenantId)",
                "device_states": {
                    "$deviceId": {
                        // WRITE: Only the device itself OR a super_admin
                        ".write": "auth != null && (auth.token.deviceId === $deviceId || auth.token.role === 'super_admin' || auth.uid === 'device:' + $deviceId)",
                        // READ: Device itself, Users of this tenant, or super_admin
                        ".read": "auth != null && (auth.token.deviceId === $deviceId || auth.token.tenantId === $tenantId || auth.token.role === 'super_admin')"
                    }
                },
                "device_commands": {
                    "$deviceId": {
                        "pending": {
                            // READ: The Pico needs to read its commands
                            ".read": "auth != null && (auth.token.deviceId === $deviceId || auth.token.role === 'super_admin' || auth.uid === 'device:' + $deviceId)",
                            // WRITE: Users send commands, Pico deletes them after processing
                            ".write": "auth != null && (auth.token.tenantId === $tenantId || auth.token.deviceId === $deviceId || auth.token.role === 'super_admin' || auth.uid === 'device:' + $deviceId)"
                        }
                    }
                },
                "presence": {
                    "$deviceId": {
                        // READ: Anyone in the tenant can see if the device is online
                        ".read": "auth != null && (auth.token.tenantId === $tenantId || auth.token.role === 'super_admin' || auth.token.deviceId === $deviceId)",
                        // WRITE: Only the device itself can update its presence heartbeat
                        ".write": "auth != null && (auth.token.deviceId === $deviceId || auth.uid === 'device:' + $deviceId || auth.token.role === 'super_admin')"
                    }
                }
            }
        }
    }
}